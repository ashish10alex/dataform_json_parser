<h1 align=center><code>dj</code></h1>

⚠️ **This is not an officially supported Google product.**

CLI tool to parse Dataform json file generated by running <code>dataform compile --json</code> to get insights on
* cost
* errors
* other metadata

at table and tag level.

#### Table of Contents
- [Usage](#usage)
- [Installation](#installation)
- [To BigQuery](#to-bigquery)



### [Usage](#usage)


at table and tag level.

To explore all capabilities of `dj` run the following command

```bash
dj help
```

Cost of of running all tables in Dataform project

```bash
dj --json-file <path-to-json-file> table-ops cost --all
```
OR (using stdin as input )

```bash
dataform compile --json | dj table-ops cost --all
`

Cost of of running a table
```bash
dj --json-file <path-to-json-file> table-ops cost --table <table-name>
```

Compiled query for a table

```bash
dj --json-file <path-to-json-file> table-ops query --table <table-name>
```

List unique tags in Dataform project
```bash
dj --json-file <path-to-json-file> tag-ops --unique
```

Cost of of running a tag
```bash
dj --json-file <path-to-json-file> tag-ops cost --tag <tag-name>
```

### [Installation](#installation)

```bash
git clone <repo-url>
just build # this assumes that you have a ~/bin directory which is in your PATH and just cli is installed
```

### [To BigQuery](#to-bigquery)

Transfer the cost of tags to BigQuery along with dry run metadata by adding the following [just config](https://github.com/casey/just)

```bash
tags_cost_to_bigquery:
    dataform compile --json > out.json;
    dj --json-file out.json tag-ops cost --all > res.json
    bq load --source_format=NEWLINE_DELIMITED_JSON --autodetect dataset_id.TAGS_RUN_COSTS res.json
```

Query the cost of a tag when it is successfully transferred to BigQuery

```bash
    SELECT
     GitMetadata.GitRepositoryId,
     GBProcessed,
     Cost,
     HasError,
     RunDateTime,
     FROM `gcp-project-id.dataset_id.TAGS_RUN_COSTS`
    WHERE 1=1
    AND Tag = "xxx"
    AND RunDateTime IN (
      SELECT RunDateTime FROM (
        SELECT  RunDateTime, ROW_NUMBER() OVER(PARTITION BY GitMetadata.GitRepositoryId ORDER BY RunDateTime DESC ) RN FROM `gcp-project-id.dataset_id.TAGS_RUN_COSTS` QUALIFY RN = 1
      )
    )
```

Query cost of all tags in a Dataform prject

```bash
    SELECT
     GitMetadata.GitRepositoryId,
     Tag,
     GBProcessed,
     Cost,
     HasError,
     RunDateTime,
     FROM `gcp-project-id.dataset_id.TAGS_RUN_COSTS`
    WHERE 1=1
    AND GitMetadata.GitRepositoryId = 'xxx'
    AND RunDateTime IN (
      SELECT RunDateTime FROM (
        SELECT  RunDateTime, ROW_NUMBER() OVER(PARTITION BY GitMetadata.GitRepositoryId ORDER BY RunDateTime DESC ) RN FROM `gcp-project-id.dataset_id.TAGS_RUN_COSTS` QUALIFY RN = 1
      )
    )
```
